<%- include('partials/header') %>

<% if (message) { %>
    <div class="bg-green-900/50 border border-green-500 rounded-lg p-4 mb-6 text-green-300">
        <i class="fas fa-check-circle mr-2"></i><%= message === 'banned' ? 'Ban added successfully!' : message === 'unbanned' ? 'Player unbanned successfully!' : message %>
    </div>
<% } %>

<% if (errors && errors.length > 0) { %>
    <div class="bg-red-900/50 border border-red-500 rounded-lg p-4 mb-6 text-red-300">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <ul class="list-disc list-inside mt-2">
            <% errors.forEach(error => { %>
                <li><%= error %></li>
            <% }); %>
        </ul>
    </div>
<% } %>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-6 gap-6 mb-6">
    <div class="card p-6 rounded-xl border border-purple-500/20">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm uppercase tracking-wide mb-2">Total Bans</p>
                <p class="text-4xl font-black text-white"><%= stats.total.toLocaleString() %></p>
            </div>
            <div class="w-16 h-16 bg-gradient-to-br from-slate-500 to-slate-600 rounded-xl flex items-center justify-center">
                <i class="fas fa-ban text-white text-2xl"></i>
            </div>
        </div>
    </div>
    <div class="card p-6 rounded-xl border border-purple-500/20">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm uppercase tracking-wide mb-2">Active Bans</p>
                <p class="text-4xl font-black text-red-400"><%= stats.active.toLocaleString() %></p>
            </div>
            <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-rose-500 rounded-xl flex items-center justify-center">
                <i class="fas fa-ban text-white text-2xl"></i>
            </div>
        </div>
    </div>
    <div class="card p-6 rounded-xl border border-purple-500/20">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm uppercase tracking-wide mb-2">Player Bans</p>
                <p class="text-4xl font-black text-blue-400"><%= stats.playerBans.toLocaleString() %></p>
            </div>
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center">
                <i class="fas fa-user-slash text-white text-2xl"></i>
            </div>
        </div>
    </div>
    <div class="card p-6 rounded-xl border border-purple-500/20">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm uppercase tracking-wide mb-2">IP Bans</p>
                <p class="text-4xl font-black text-orange-400"><%= stats.ipBans.toLocaleString() %></p>
            </div>
            <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-500 rounded-xl flex items-center justify-center">
                <i class="fas fa-network-wired text-white text-2xl"></i>
            </div>
        </div>
    </div>
    <div class="card p-6 rounded-xl border border-purple-500/20">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm uppercase tracking-wide mb-2">Expired</p>
                <p class="text-4xl font-black text-yellow-400"><%= stats.expired.toLocaleString() %></p>
            </div>
            <div class="w-16 h-16 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl flex items-center justify-center">
                <i class="fas fa-clock text-white text-2xl"></i>
            </div>
        </div>
    </div>
    <div class="card p-6 rounded-xl border border-purple-500/20">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm uppercase tracking-wide mb-2">Inactive</p>
                <p class="text-4xl font-black text-slate-400"><%= stats.inactive.toLocaleString() %></p>
            </div>
            <div class="w-16 h-16 bg-gradient-to-br from-slate-600 to-slate-700 rounded-xl flex items-center justify-center">
                <i class="fas fa-check-circle text-white text-2xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Ban Type Tabs -->
<div class="flex gap-2 mb-6 border-b border-slate-700">
    <a href="?type=all&filter=<%= filter %><%= search ? '&search=' + encodeURIComponent(search) : '' %>" 
       class="px-6 py-3 font-semibold <%= banType === 'all' ? 'border-b-2 border-purple-500 text-purple-400' : 'text-slate-400 hover:text-white' %> transition">
        <i class="fas fa-list mr-2"></i>All Bans
    </a>
    <a href="?type=player&filter=<%= filter %><%= search ? '&search=' + encodeURIComponent(search) : '' %>" 
       class="px-6 py-3 font-semibold <%= banType === 'player' ? 'border-b-2 border-purple-500 text-purple-400' : 'text-slate-400 hover:text-white' %> transition">
        <i class="fas fa-user-slash mr-2"></i>Player Bans
    </a>
    <a href="?type=ip&filter=<%= filter %><%= search ? '&search=' + encodeURIComponent(search) : '' %>" 
       class="px-6 py-3 font-semibold <%= banType === 'ip' ? 'border-b-2 border-purple-500 text-purple-400' : 'text-slate-400 hover:text-white' %> transition">
        <i class="fas fa-network-wired mr-2"></i>IP Bans
    </a>
</div>

<!-- Actions & Filters -->
<div class="card p-6 mb-6 rounded-xl">
    <div class="flex flex-wrap gap-4 items-center justify-between">
        <div class="flex gap-2">
            <button onclick="openAddBanModal('player')" class="btn-primary px-6 py-3 rounded-lg text-white font-semibold">
                <i class="fas fa-user-slash mr-2"></i>Add Player Ban
            </button>
            <button onclick="openAddBanModal('ip')" class="bg-orange-600 hover:bg-orange-700 px-6 py-3 rounded-lg text-white font-semibold transition">
                <i class="fas fa-network-wired mr-2"></i>Add IP Ban
            </button>
            <button onclick="exportBans()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg text-white font-semibold transition">
                <i class="fas fa-download mr-2"></i>Export CSV
            </button>
        </div>
        <div class="flex gap-2 flex-wrap">
            <form method="GET" class="flex gap-2">
                <input type="hidden" name="filter" value="<%= filter %>">
                <input type="hidden" name="type" value="<%= banType %>">
                <input type="text" name="search" placeholder="Search player or IP..." value="<%= search %>"
                       class="bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-purple-500 focus:outline-none">
                <button type="submit" class="btn-primary px-4 py-2 rounded-lg text-white">
                    <i class="fas fa-search"></i>
                </button>
                <% if (search) { %>
                    <a href="?filter=<%= filter %>&type=<%= banType %>" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-white flex items-center">
                        <i class="fas fa-times"></i>
                    </a>
                <% } %>
            </form>
            <select name="filter" onchange="window.location.href='?filter=' + this.value + '&type=<%= banType %><%= search ? '&search=' + encodeURIComponent(search) : '' %>'" 
                    class="bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-purple-500 focus:outline-none">
                <option value="active" <%= filter === 'active' ? 'selected' : '' %>>Active</option>
                <option value="expired" <%= filter === 'expired' ? 'selected' : '' %>>Expired</option>
                <option value="inactive" <%= filter === 'inactive' ? 'selected' : '' %>>Inactive</option>
                <option value="all" <%= filter === 'all' ? 'selected' : '' %>>All</option>
            </select>
        </div>
    </div>
</div>

<!-- Bans Table -->
<div class="card rounded-xl overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full" id="bansTable">
            <thead class="bg-slate-900/50">
                <tr>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Player / IP</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Reason</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Banned By</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Expires</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-700">
                <% if (!bans || bans.length === 0) { %>
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-slate-400">
                            <i class="fas fa-ban text-4xl mb-4 text-slate-600"></i>
                            <p class="text-lg">No bans found</p>
                            <p class="text-sm mt-2">Try adjusting your filters or add a new ban</p>
                        </td>
                    </tr>
                <% } else { %>
                    <% bans.forEach(ban => { %>
                        <tr class="hover:bg-slate-800/50 transition">
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-gradient-to-br <%= ban.ban_type === 'ip' ? 'from-orange-500 to-red-500' : 'from-red-500 to-red-600' %> rounded-lg flex items-center justify-center">
                                        <i class="fas <%= ban.ban_type === 'ip' ? 'fa-network-wired' : 'fa-user-slash' %> text-white"></i>
                                    </div>
                                    <div>
                                        <% if (ban.ban_type === 'ip') { %>
                                            <p class="font-semibold text-white font-mono"><%= ban.ip_address %></p>
                                            <% if (ban.player_username) { %>
                                                <p class="text-xs text-slate-500">Player: <%= ban.player_username %></p>
                                            <% } %>
                                        <% } else { %>
                                            <p class="font-semibold text-white"><%= ban.player_username || 'Unknown' %></p>
                                            <% if (ban.player_uuid) { %>
                                                <p class="text-xs text-slate-500 font-mono"><%= ban.player_uuid.substring(0, 8) %>...</p>
                                            <% } %>
                                        <% } %>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <% if (ban.ban_type === 'ip') { %>
                                    <span class="bg-orange-900/50 text-orange-400 px-3 py-1 rounded-full text-xs font-semibold">IP Ban</span>
                                <% } else { %>
                                    <span class="bg-blue-900/50 text-blue-400 px-3 py-1 rounded-full text-xs font-semibold">Player Ban</span>
                                <% } %>
                            </td>
                            <td class="px-6 py-4">
                                <div class="max-w-xs">
                                    <p class="text-slate-300 text-sm"><%= ban.reason %></p>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-slate-300"><%= ban.banned_by %></span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-slate-400 text-sm"><%= new Date(ban.ban_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></span>
                            </td>
                            <td class="px-6 py-4">
                                <% if (ban.expires_at) { %>
                                    <% const expiresDate = new Date(ban.expires_at); %>
                                    <% if (expiresDate.getTime() < Date.now()) { %>
                                        <span class="bg-green-900/50 text-green-400 px-2 py-1 rounded text-xs">Expired</span>
                                    <% } else { %>
                                        <span class="text-slate-300 text-sm"><%= expiresDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></span>
                                    <% } %>
                                <% } else { %>
                                    <span class="bg-red-900/50 text-red-400 px-2 py-1 rounded text-xs">
                                        <i class="fas fa-infinity mr-1"></i>Permanent
                                    </span>
                                <% } %>
                            </td>
                            <td class="px-6 py-4">
                                <% if (ban.active) { %>
                                    <span class="bg-red-900/50 text-red-400 px-3 py-1 rounded-full text-xs font-semibold">Active</span>
                                <% } else { %>
                                    <span class="bg-slate-700 text-slate-300 px-3 py-1 rounded-full text-xs font-semibold">Inactive</span>
                                <% } %>
                            </td>
                            <td class="px-6 py-4">
                                <% if (ban.active) { %>
                                    <form method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to unban <%= ban.ban_type === 'ip' ? ban.ip_address : ban.player_username %>?');">
                                        <input type="hidden" name="action" value="unban">
                                        <input type="hidden" name="ban_id" value="<%= ban.id %>">
                                        <button type="submit" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-white text-sm font-semibold transition">
                                            <i class="fas fa-unlock mr-1"></i>Unban
                                        </button>
                                    </form>
                                <% } else { %>
                                    <span class="text-slate-500 text-sm">No actions</span>
                                <% } %>
                            </td>
                        </tr>
                    <% }); %>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<!-- Add Ban Modal -->
<div id="addBanModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-slate-800 rounded-xl p-8 max-w-lg w-full border border-purple-500/20 shadow-2xl">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-white flex items-center">
                <i class="fas fa-ban text-red-400 mr-3"></i><span id="modalTitle">Add Ban</span>
            </h2>
            <button onclick="closeAddBanModal()" class="text-slate-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form method="POST" class="space-y-4" id="banForm">
            <input type="hidden" name="action" value="add">
            <input type="hidden" name="ban_type" id="banTypeInput" value="player">
            
            <!-- Ban Type Toggle -->
            <div class="flex gap-2 mb-4">
                <button type="button" onclick="switchBanType('player')" id="playerBanBtn" class="flex-1 px-4 py-2 rounded-lg font-semibold bg-purple-600 text-white">
                    <i class="fas fa-user-slash mr-2"></i>Player Ban
                </button>
                <button type="button" onclick="switchBanType('ip')" id="ipBanBtn" class="flex-1 px-4 py-2 rounded-lg font-semibold bg-slate-700 text-slate-300 hover:bg-slate-600">
                    <i class="fas fa-network-wired mr-2"></i>IP Ban
                </button>
            </div>
            
            <!-- Player Ban Fields -->
            <div id="playerBanFields">
                <div>
                    <label class="block text-slate-300 mb-2 text-sm font-medium">Username *</label>
                    <input type="text" name="username" id="usernameInput"
                           class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-purple-500 focus:outline-none transition"
                           placeholder="Player username">
                </div>
                <div>
                    <label class="block text-slate-300 mb-2 text-sm font-medium">UUID (optional)</label>
                    <input type="text" name="uuid" id="uuidInput"
                           class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-purple-500 focus:outline-none transition font-mono text-sm"
                           placeholder="00000000-0000-0000-0000-000000000000">
                </div>
            </div>
            
            <!-- IP Ban Fields -->
            <div id="ipBanFields" class="hidden">
                <div>
                    <label class="block text-slate-300 mb-2 text-sm font-medium">IP Address *</label>
                    <input type="text" name="ip_address" id="ipAddressInput"
                           class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-purple-500 focus:outline-none transition font-mono"
                           placeholder="192.168.1.1"
                           pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
                    <p class="text-xs text-slate-500 mt-1">Enter the IP address to ban</p>
                </div>
                <div>
                    <label class="block text-slate-300 mb-2 text-sm font-medium">Player Name / Username (optional)</label>
                    <input type="text" name="ip_ban_name" id="ipBanNameInput"
                           class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-purple-500 focus:outline-none transition"
                           placeholder="Player username or name">
                    <p class="text-xs text-slate-500 mt-1">Optional: Enter the player's name/username for reference</p>
                    <p class="text-xs text-slate-500 mt-1">Optional: Enter the player's username for easier identification</p>
                </div>
            </div>
            <div>
                <label class="block text-slate-300 mb-2 text-sm font-medium">Reason *</label>
                <textarea name="reason" required rows="4"
                          class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-purple-500 focus:outline-none transition"
                          placeholder="Reason for the ban"></textarea>
            </div>
            <div>
                <label class="block text-slate-300 mb-2 text-sm font-medium">Duration</label>
                <select name="duration" id="durationSelect" onchange="toggleCustomDate()"
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-purple-500 focus:outline-none transition">
                    <option value="permanent">Permanent</option>
                    <option value="1">1 Day</option>
                    <option value="7">7 Days</option>
                    <option value="30">30 Days</option>
                    <option value="custom">Custom Date</option>
                </select>
            </div>
            <div id="customDateContainer" class="hidden">
                <label class="block text-slate-300 mb-2 text-sm font-medium">Custom Expiry Date</label>
                <input type="datetime-local" name="custom_date" 
                       class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-purple-500 focus:outline-none transition">
            </div>
            <div id="emailFields">
                <div>
                    <label class="block text-slate-300 mb-2 text-sm font-medium">Player Email (for notification)</label>
                    <input type="email" name="player_email" id="playerEmailInput"
                           class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-purple-500 focus:outline-none transition"
                           placeholder="player@example.com">
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" name="send_email" id="sendEmail" class="w-4 h-4 text-purple-600 bg-slate-900 border-slate-700 rounded focus:ring-purple-500">
                    <label for="sendEmail" class="text-slate-300 text-sm">Send email notification</label>
                </div>
            </div>
            <div class="flex gap-3 pt-4">
                <button type="submit" class="flex-1 btn-primary px-6 py-3 rounded-lg text-white font-semibold">
                    <i class="fas fa-ban mr-2"></i><span id="submitBtnText">Add Ban</span>
                </button>
                <button type="button" onclick="closeAddBanModal()" 
                        class="bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded-lg text-white font-semibold transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script>
    $(document).ready(function() {
        $('#bansTable').DataTable({
            pageLength: 25,
            order: [[3, 'desc']], // Sort by date descending
            language: {
                search: "Search:",
                lengthMenu: "Show _MENU_ entries",
                info: "Showing _START_ to _END_ of _TOTAL_ bans",
                infoEmpty: "No bans to show",
                infoFiltered: "(filtered from _MAX_ total bans)"
            },
            dom: '<"flex justify-between items-center mb-4"<"flex gap-2"l><"flex gap-2"f>>rt<"flex justify-between items-center mt-4"<"flex gap-2"i><"flex gap-2"p>>'
        });
    });

    function toggleCustomDate() {
        const durationSelect = document.getElementById('durationSelect');
        const customDateContainer = document.getElementById('customDateContainer');
        if (durationSelect.value === 'custom') {
            customDateContainer.classList.remove('hidden');
        } else {
            customDateContainer.classList.add('hidden');
        }
    }

    function openAddBanModal(type) {
        document.getElementById('addBanModal').classList.remove('hidden');
        switchBanType(type);
    }

    function closeAddBanModal() {
        document.getElementById('addBanModal').classList.add('hidden');
        document.getElementById('banForm').reset();
    }

    function exportBans() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/bans/export';
        form.innerHTML = `
            <input type="hidden" name="format" value="csv">
            <input type="hidden" name="filter" value="<%= filter %>">
            <input type="hidden" name="search" value="<%= search %>">
            <input type="hidden" name="banType" value="<%= banType %>">
        `;
        document.body.appendChild(form);
        form.submit();
    }

    function switchBanType(type) {
        const banTypeInput = document.getElementById('banTypeInput');
        const playerBanFields = document.getElementById('playerBanFields');
        const ipBanFields = document.getElementById('ipBanFields');
        const emailFields = document.getElementById('emailFields');
        const playerBanBtn = document.getElementById('playerBanBtn');
        const ipBanBtn = document.getElementById('ipBanBtn');
        const modalTitle = document.getElementById('modalTitle');
        const submitBtnText = document.getElementById('submitBtnText');
        const usernameInput = document.getElementById('usernameInput');
        const ipAddressInput = document.getElementById('ipAddressInput');

        banTypeInput.value = type;

        if (type === 'ip') {
            playerBanFields.classList.add('hidden');
            ipBanFields.classList.remove('hidden');
            emailFields.classList.add('hidden');
            playerBanBtn.className = 'flex-1 px-4 py-2 rounded-lg font-semibold bg-slate-700 text-slate-300 hover:bg-slate-600';
            ipBanBtn.className = 'flex-1 px-4 py-2 rounded-lg font-semibold bg-orange-600 text-white';
            modalTitle.textContent = 'Add IP Ban';
            submitBtnText.textContent = 'Add IP Ban';
            usernameInput.removeAttribute('required');
            ipAddressInput.setAttribute('required', 'required');
        } else {
            playerBanFields.classList.remove('hidden');
            ipBanFields.classList.add('hidden');
            emailFields.classList.remove('hidden');
            playerBanBtn.className = 'flex-1 px-4 py-2 rounded-lg font-semibold bg-purple-600 text-white';
            ipBanBtn.className = 'flex-1 px-4 py-2 rounded-lg font-semibold bg-slate-700 text-slate-300 hover:bg-slate-600';
            modalTitle.textContent = 'Add Player Ban';
            submitBtnText.textContent = 'Add Ban';
            usernameInput.setAttribute('required', 'required');
            ipAddressInput.removeAttribute('required');
        }
    }
</script>

<%- include('partials/footer') %>
