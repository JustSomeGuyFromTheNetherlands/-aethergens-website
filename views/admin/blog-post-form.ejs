<%- include('partials/header') %>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <%- include('partials/sidebar') %>

    <!-- Main Content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <!-- Page Header -->
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <div>
          <h1 class="h2"><%= pageTitle %></h1>
          <p class="text-muted"><%= pageSubtitle %></p>
        </div>
        <div class="btn-toolbar mb-2 mb-md-0">
          <a href="/admin/blog" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Blog
          </a>
        </div>
      </div>

      <!-- Form Card -->
      <div class="card">
        <div class="card-body">
          <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger" role="alert">
              <i class="fas fa-exclamation-triangle"></i>
              <%= error %>
            </div>
          <% } %>

          <form action="<%= isEdit ? `/admin/blog/posts/${post.id}` : '/admin/blog/posts' %>" method="POST" id="blogPostForm">
            <div class="row">
              <!-- Main Content Column -->
              <div class="col-lg-8">
                <div class="mb-3">
                  <label for="title" class="form-label">Post Title <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="title" name="title"
                         value="<%= post ? post.title : '' %>" required
                         placeholder="Enter an engaging title">
                </div>

                <div class="mb-3">
                  <label for="slug" class="form-label">URL Slug</label>
                  <input type="text" class="form-control" id="slug" name="slug"
                         value="<%= post ? post.slug : '' %>"
                         placeholder="leave-empty-for-auto-generate">
                  <div class="form-text">Leave empty to auto-generate from title</div>
                </div>

                <div class="mb-3">
                  <label for="excerpt" class="form-label">Excerpt</label>
                  <textarea class="form-control" id="excerpt" name="excerpt" rows="3"
                            placeholder="Brief summary of the post"><%= post ? post.excerpt : '' %></textarea>
                  <div class="form-text">Short description shown in previews</div>
                </div>

                <div class="mb-3">
                  <label for="content" class="form-label">Content <span class="text-danger">*</span></label>
                  <textarea class="form-control" id="content" name="content" rows="15" required
                            placeholder="Write your post content here..."><%= post ? post.content : '' %></textarea>
                  <div class="form-text">Supports HTML and basic formatting</div>
                </div>

                <!-- Tags Section -->
                <div class="mb-3">
                  <label class="form-label">Tags</label>
                  <div id="tagsContainer">
                    <% if (post && post.tags && post.tags.length > 0) { %>
                      <% post.tags.forEach(tagId => { %>
                        <% const tag = tags.find(t => t.id == tagId); %>
                        <% if (tag) { %>
                          <span class="badge me-2 mb-2" style="background-color: <%= tag.color %>20; color: <%= tag.color %>; border: 1px solid <%= tag.color %>40;">
                            <%= tag.name %>
                            <input type="hidden" name="tags[]" value="<%= tag.id %>">
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeTag(this)" style="font-size: 0.6em;"></button>
                          </span>
                        <% } %>
                      <% }); %>
                    <% } %>
                  </div>
                  <select class="form-select" id="tagSelect">
                    <option value="">Add a tag...</option>
                    <% tags.forEach(tag => { %>
                      <option value="<%= tag.id %>" data-color="<%= tag.color %>"><%= tag.name %></option>
                    <% }); %>
                  </select>
                </div>
              </div>

              <!-- Sidebar Column -->
              <div class="col-lg-4">
                <!-- Publish Settings -->
                <div class="card mb-3">
                  <div class="card-header">
                    <h6 class="mb-0">Publish Settings</h6>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label for="status" class="form-label">Status</label>
                      <select class="form-select" id="status" name="status">
                        <option value="draft" <%= post && post.status === 'draft' ? 'selected' : '' %>>Draft</option>
                        <option value="published" <%= post && post.status === 'published' ? 'selected' : '' %>>Published</option>
                        <option value="archived" <%= post && post.status === 'archived' ? 'selected' : '' %>>Archived</option>
                      </select>
                    </div>

                    <div class="mb-3" id="publishDateGroup">
                      <label for="published_at" class="form-label">Publish Date</label>
                      <input type="datetime-local" class="form-control" id="published_at" name="published_at"
                             value="<%= post && post.published_at ? new Date(post.published_at).toISOString().slice(0, 16) : '' %>">
                      <div class="form-text">Leave empty for immediate publish</div>
                    </div>

                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="comments_enabled" name="comments_enabled" value="1"
                               <%= post && post.comments_enabled ? 'checked' : (!post ? 'checked' : '') %>>
                        <label class="form-check-label" for="comments_enabled">
                          Allow Comments
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Category -->
                <div class="card mb-3">
                  <div class="card-header">
                    <h6 class="mb-0">Category</h6>
                  </div>
                  <div class="card-body">
                    <select class="form-select" id="category_id" name="category_id">
                      <option value="">Uncategorized</option>
                      <% categories.forEach(category => { %>
                        <option value="<%= category.id %>"
                                <%= post && post.category_id == category.id ? 'selected' : '' %>
                                style="color: <%= category.color %>;">
                          <%= category.name %>
                        </option>
                      <% }); %>
                    </select>
                  </div>
                </div>

                <!-- Featured Image -->
                <div class="card mb-3">
                  <div class="card-header">
                    <h6 class="mb-0">Featured Image</h6>
                  </div>
                  <div class="card-body">
                    <input type="url" class="form-control" id="featured_image" name="featured_image"
                           value="<%= post ? post.featured_image : '' %>"
                           placeholder="https://example.com/image.jpg">
                    <div class="form-text">Enter image URL</div>
                  </div>
                </div>

                <!-- SEO Settings -->
                <div class="card">
                  <div class="card-header">
                    <h6 class="mb-0">SEO Settings</h6>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label for="seo_title" class="form-label">Meta Title</label>
                      <input type="text" class="form-control" id="seo_title" name="seo_title"
                             value="<%= post ? post.seo_title : '' %>"
                             maxlength="60">
                      <div class="form-text">Leave empty to use post title</div>
                    </div>

                    <div class="mb-3">
                      <label for="seo_description" class="form-label">Meta Description</label>
                      <textarea class="form-control" id="seo_description" name="seo_description"
                                rows="3" maxlength="160"><%= post ? post.seo_description : '' %></textarea>
                      <div class="form-text">Leave empty to use excerpt</div>
                    </div>

                    <div class="mb-3">
                      <label for="seo_keywords" class="form-label">Meta Keywords</label>
                      <input type="text" class="form-control" id="seo_keywords" name="seo_keywords"
                             value="<%= post ? post.seo_keywords : '' %>"
                             placeholder="keyword1, keyword2, keyword3">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="row mt-4">
              <div class="col-12">
                <div class="d-flex justify-content-between">
                  <div>
                    <% if (isEdit) { %>
                      <a href="/blog/<%= post.slug %>" target="_blank" class="btn btn-outline-info">
                        <i class="fas fa-eye"></i> Preview
                      </a>
                    <% } %>
                  </div>
                  <div>
                    <a href="/admin/blog/posts" class="btn btn-outline-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-save"></i>
                      <%= isEdit ? 'Update Post' : 'Create Post' %>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('blogPostForm');
  const statusSelect = document.getElementById('status');
  const publishDateGroup = document.getElementById('publishDateGroup');
  const tagSelect = document.getElementById('tagSelect');
  const tagsContainer = document.getElementById('tagsContainer');

  // Auto-generate slug from title
  document.getElementById('title').addEventListener('input', function() {
    const title = this.value;
    const slugField = document.getElementById('slug');
    if (!slugField.value) {
      const slug = title.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
      slugField.value = slug;
    }
  });

  // Show/hide publish date based on status
  function updatePublishDateVisibility() {
    if (statusSelect.value === 'published') {
      publishDateGroup.style.display = 'block';
    } else {
      publishDateGroup.style.display = 'none';
    }
  }

  statusSelect.addEventListener('change', updatePublishDateVisibility);
  updatePublishDateVisibility();

  // Tag management
  tagSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (!selectedOption.value) return;

    const tagId = selectedOption.value;
    const tagName = selectedOption.text;
    const tagColor = selectedOption.dataset.color;

    // Check if tag already added
    const existingTags = tagsContainer.querySelectorAll('input[name="tags[]"]');
    for (const input of existingTags) {
      if (input.value === tagId) return;
    }

    // Add tag badge
    const badge = document.createElement('span');
    badge.className = 'badge me-2 mb-2';
    badge.style.backgroundColor = tagColor + '20';
    badge.style.color = tagColor;
    badge.style.border = `1px solid ${tagColor}40`;
    badge.innerHTML = `
      ${tagName}
      <input type="hidden" name="tags[]" value="${tagId}">
      <button type="button" class="btn-close btn-close-white ms-1" onclick="removeTag(this)" style="font-size: 0.6em;"></button>
    `;

    tagsContainer.appendChild(badge);
    this.value = '';
  });

  // Character counters for SEO fields
  const seoTitle = document.getElementById('seo_title');
  const seoDescription = document.getElementById('seo_description');

  seoTitle.addEventListener('input', function() {
    this.nextElementSibling.textContent = `Leave empty to use post title (${this.value.length}/60)`;
  });

  seoDescription.addEventListener('input', function() {
    this.nextElementSibling.textContent = `Leave empty to use excerpt (${this.value.length}/160)`;
  });
});

function removeTag(button) {
  button.closest('.badge').remove();
}
</script>

<%- include('partials/footer') %>
