<%- include('partials/header') %>

<% if (message === 'reviewed') { %>
    <div class="bg-green-900/50 border border-green-500 rounded-lg p-4 mb-6 text-green-300">
        <i class="fas fa-check-circle mr-2"></i>Appeal reviewed successfully!
    </div>
<% } %>

<div class="mb-4 flex justify-between items-center">
    <div class="flex gap-2">
        <button onclick="exportTable('appealsTable')" class="btn-primary px-4 py-2 rounded text-sm text-white">
            <i class="fas fa-download mr-2"></i>Export CSV
        </button>
    </div>
</div>

<div class="space-y-4" id="appealsContainer">
    <% if (!appeals || appeals.length === 0) { %>
        <div class="card p-6 text-center text-slate-400">No pending appeals.</div>
    <% } else { %>
        <table id="appealsTable" class="w-full card rounded-xl overflow-hidden">
            <thead class="bg-slate-900">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Player</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Ban Reason</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Appeal Text</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-700">
                <% appeals.forEach(appeal => { %>
                    <tr class="hover:bg-slate-900">
                        <td class="px-6 py-4 font-medium text-white"><%= appeal.player_username %></td>
                        <td class="px-6 py-4 text-slate-300"><%= appeal.ban_reason || 'N/A' %></td>
                        <td class="px-6 py-4 text-slate-300 max-w-md">
                            <div class="truncate" title="<%= appeal.appeal_text %>">
                                <%= appeal.appeal_text.substring(0, 100) %><%= appeal.appeal_text.length > 100 ? '...' : '' %>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-slate-400"><%= new Date(appeal.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <form method="POST" class="inline" onsubmit="return confirm('Accept this appeal?');">
                                    <input type="hidden" name="action" value="review">
                                    <input type="hidden" name="appeal_id" value="<%= appeal.id %>">
                                    <input type="hidden" name="decision" value="accepted">
                                    <button type="submit" class="btn-success px-3 py-1 rounded text-xs text-white">Accept</button>
                                </form>
                                <form method="POST" class="inline" onsubmit="return confirm('Deny this appeal?');">
                                    <input type="hidden" name="action" value="review">
                                    <input type="hidden" name="appeal_id" value="<%= appeal.id %>">
                                    <input type="hidden" name="decision" value="denied">
                                    <button type="submit" class="btn-danger px-3 py-1 rounded text-xs text-white">Deny</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    <% } %>
</div>

<% if (appeals && appeals.length > 0) { %>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<script>
$(document).ready(function() {
    $('#appealsTable').DataTable({
        pageLength: 25,
        order: [[3, 'desc']],
        language: {
            search: "Search appeals:",
            lengthMenu: "Show _MENU_ appeals per page",
            info: "Showing _START_ to _END_ of _TOTAL_ appeals",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        },
        dom: '<"flex justify-between items-center mb-4"<"flex gap-2"l><"flex gap-2"f>>rt<"flex justify-between items-center mt-4"<"text-slate-400"i><"flex gap-2"p>>',
        drawCallback: function() {
            $('.dataTables_wrapper').css('color', '#e2e8f0');
            $('.dataTables_filter input').addClass('bg-slate-800 border-slate-700 text-white');
            $('.dataTables_length select').addClass('bg-slate-800 border-slate-700 text-white');
            $('.dataTables_paginate a').addClass('text-slate-300 hover:text-white');
        }
    });
});

function exportTable(tableId) {
    const table = document.getElementById(tableId);
    let csv = [];
    const rows = table.querySelectorAll('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = [], cols = rows[i].querySelectorAll('td, th');
        for (let j = 0; j < cols.length - 1; j++) {
            let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '');
            row.push('"' + data + '"');
        }
        csv.push(row.join(','));
    }
    
    const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
    const downloadLink = document.createElement('a');
    downloadLink.download = 'appeals_' + new Date().toISOString().split('T')[0] + '.csv';
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}
</script>
<% } %>

<%- include('partials/footer') %>


